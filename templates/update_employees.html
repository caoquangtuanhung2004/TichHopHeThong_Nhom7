<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='update_employees.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <title>Cập nhật nhân viên</title>
</head>

<body>

    <div class="container col-md-6">
        <div>
            <button class="btn-back" onclick="history.back()">← Quay lại</button>
        </div>
        <div class="card shadow p-4">
            <h3>Cập nhật Nhân Viên</h3>

            <div class="mb-3">
                <label class="form-label">ID Nhân viên</label>
                <input type="number" id="EmployeeID" class="form-control" readonly>
            </div>

            <div class="mb-3">
                <label class="form-label">Họ và tên</label>
                <input type="text" id="FullName" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Ngày sinh</label>
                <input type="date" id="DateOfBirth" name="DateOfBirth" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Giới tính</label>
                <select id="Gender" class="form-select">
                    <option value="">-- Chọn giới tính --</option>
                    <option>Nam</option>
                    <option>Nữ</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" id="PhoneNumber" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="Email" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Ngày vào làm</label>
                <input type="date" id="HireDate" name="HireDate" class="form-control">
            </div>

            <div class="mb-3">
                <label class="form-label">Phòng ban</label>
                <select id="DepartmentID" class="form-select"></select>
            </div>

            <div class="mb-3">
                <label class="form-label">Chức vụ</label>
                <select id="PositionID" class="form-select"></select>
            </div>

            <div class="mb-3">
                <label class="form-label">Trạng thái</label>

                <select id="Status" name="Status" class="form-control">
                    <option value="">-- Chọn trạng thái --</option>
                    <option value="Đang làm việc">Đang làm việc</option>
                    <option value="Nghỉ phép">Nghỉ phép</option>
                    <option value="Thử việc">Thử việc</option>
                    <option value="Thực tập">Thực tập</option>
                </select>

            </div>
            <button class="btn btn-primary w-100" onclick="updateEmployee()">Cập nhật</button>
            <div id="msg" class="mt-3 fw-bold text-center"></div>
        </div>
    </div>

    <script>

        // Hàm chuẩn hoá ngày
        function formatDate(d) {
            if (!d) return "";
            const date = new Date(d);
            if (isNaN(date)) return "";
            return date.toISOString().split("T")[0];
        }

        // Load Phòng Ban
        function loadDepartments(selectedID) {
            return fetch("/departments")
                .then(res => res.json())
                .then(data => {
                    let html = '<option value="">-- Chọn phòng ban --</option>';
                    data.forEach(d => {
                        html += `<option value="${d.DepartmentID}">${d.DepartmentName}</option>`;
                    });
                    document.getElementById("DepartmentID").innerHTML = html;

                    if (selectedID) {
                        document.getElementById("DepartmentID").value = selectedID;
                    }
                });
        }

        // Load Chức vụ
        function loadPositions(selectedID) {
            return fetch("/positions")
                .then(res => res.json())
                .then(data => {
                    let html = '<option value="">-- Chọn chức vụ --</option>';
                    data.forEach(p => {
                        html += `<option value="${p.PositionID}">${p.PositionName}</option>`;
                    });
                    document.getElementById("PositionID").innerHTML = html;

                    if (selectedID) {
                        document.getElementById("PositionID").value = selectedID;
                    }
                });
        }

        // Lấy ID nhân viên từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const empID = urlParams.get("id");

        // Tải thông tin nhân viên
        function loadEmployeeInfo(id) {
            fetch(`/employees/${id}`)
                .then(res => res.json())
                .then(emp => {

                    document.getElementById("EmployeeID").value = emp.EmployeeID;
                    document.getElementById("FullName").value = emp.FullName;

                    // --- FIX LỖI NGÀY KHÔNG HIỂN THỊ ---
                    document.getElementById("DateOfBirth").value = formatDate(emp.DateOfBirth);
                    document.getElementById("HireDate").value = formatDate(emp.HireDate);

                    document.getElementById("Gender").value = emp.Gender;
                    document.getElementById("PhoneNumber").value = emp.PhoneNumber;
                    document.getElementById("Email").value = emp.Email;
                    document.getElementById("Status").value = emp.Status;

                    loadDepartments(emp.DepartmentID);
                    loadPositions(emp.PositionID);
                });
        }

        function updateEmployee() {
            const emp = {
                EmployeeID: document.getElementById("EmployeeID").value,
                FullName: document.getElementById("FullName").value,
                DateOfBirth: document.getElementById("DateOfBirth").value,
                Gender: document.getElementById("Gender").value,
                PhoneNumber: document.getElementById("PhoneNumber").value,
                Email: document.getElementById("Email").value,
                HireDate: document.getElementById("HireDate").value,
                DepartmentID: document.getElementById("DepartmentID").value,
                PositionID: document.getElementById("PositionID").value,
                Status: document.getElementById("Status").value
            };

            fetch(`/employees/${emp.EmployeeID}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(emp)
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("msg").innerHTML =
                        `<span class="text-success">${data.message || "Cập nhật thành công!"}</span>`;
                })
                .catch(err => {
                    document.getElementById("msg").innerHTML =
                        `<span class="text-danger">Lỗi cập nhật!</span>`;
                    console.log(err);
                });
        }
        // chạy khi vào trang
        if (empID) loadEmployeeInfo(empID);

    </script>
</body>

</html>